{% extends "base.html" %}

{% block title %}Row Validation - Simple Validation UI{% endblock %}

{% block extra_css %}
<style>
    .validation-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 2rem;
        height: calc(100vh - 200px);
    }

    .stats-panel {
        background: white;
        border-radius: 4px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: sticky;
        top: 2rem;
        height: fit-content;
    }

    .stats-panel h3 {
        margin-bottom: 1rem;
        color: #2c3e50;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
        border-bottom: 1px solid #eee;
    }

    .stat-item:last-child {
        border-bottom: none;
    }

    .stat-value {
        font-weight: bold;
        color: #2c3e50;
    }

    .field-failures {
        margin-top: 1rem;
    }

    .field-failures h4 {
        margin-bottom: 0.5rem;
        color: #e74c3c;
    }

    .table-container {
        background: white;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        height: fit-content;
    }

    .table-wrapper {
        overflow-x: auto;
        max-height: calc(100vh - 250px);
        overflow-y: auto;
    }

    #validation-table {
        min-width: 1000px;
    }

    #validation-table th {
        position: sticky;
        top: 0;
        background-color: #2c3e50;
        color: white;
        z-index: 10;
    }

    .row-header {
        background-color: #f8f9fa;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        text-align: center;
        min-width: 50px;
    }

    .row-header:hover {
        background-color: #e9ecef;
    }

    .data-cell {
        cursor: pointer;
        user-select: none;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .data-cell:hover {
        background-color: #f0f8ff;
    }

    .data-cell.rejected {
        background-color: #ffebee !important;
        color: #c62828;
        border: 2px solid #e74c3c;
    }

    .row-rejected .data-cell {
        background-color: #ffcdd2 !important;
        color: #c62828;
    }

    .row-rejected .row-header {
        background-color: #f44336 !important;
        color: white;
    }

    .export-btn {
        width: 100%;
        margin-top: 1rem;
        background-color: #27ae60;
    }

    .export-btn:hover {
        background-color: #219a52;
    }

    .instructions {
        background-color: #e8f4fd;
        border: 1px solid #bee5eb;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }

    .instructions h4 {
        margin-bottom: 0.5rem;
        color: #2c3e50;
    }

    .instructions ul {
        margin-left: 1rem;
    }

    .instructions li {
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="loading">
    <h2>Loading validation interface...</h2>
</div>

<div class="content" style="display: none;">
    <div class="instructions">
        <h4>How to Use Row Validation:</h4>
        <ul>
            <li><strong>Click any cell</strong> to mark it as rejected (turns red)</li>
            <li><strong>Click row number</strong> to reject entire row</li>
            <li><strong>Click again</strong> to un-reject cells or rows</li>
            <li><strong>Export button</strong> downloads validation summary</li>
        </ul>
    </div>

    <div class="validation-container">
        <div class="stats-panel">
            <h3>Validation Stats</h3>
            <div id="validation-stats">
                <div class="stat-item">
                    <span>Total Rows:</span>
                    <span class="stat-value" id="total-rows">0</span>
                </div>
                <div class="stat-item">
                    <span>Failed Rows:</span>
                    <span class="stat-value" id="failed-rows">0</span>
                </div>
                <div class="stat-item">
                    <span>Pass Rate:</span>
                    <span class="stat-value" id="pass-rate">100%</span>
                </div>
            </div>
            
            <div class="field-failures">
                <h4>Field Failures</h4>
                <div id="field-failure-list">
                    <!-- Populated dynamically -->
                </div>
            </div>
            
            <button class="export-btn" onclick="exportValidation()">
                Export Validation Summary
            </button>
        </div>
        
        <div class="table-container">
            <div class="table-wrapper">
                <table id="validation-table">
                    <thead>
                        <tr>
                            <th>Row</th>
                            <!-- Column headers populated dynamically -->
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Table rows populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let tableData = [];
let validationState = {
    failed_cells: {},
    failed_rows: []
};

function onDataLoaded(response) {
    loadTableData();
}

function loadTableData() {
    $.get('/get_table_data')
        .done(function(response) {
            tableData = response.data;
            const columns = response.columns;
            validationState = response.validation_state;
            
            buildTable(columns, tableData);
            updateValidationStats();
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to load table data';
            console.error('Table data loading error:', xhr);
            showError(error);
        });
}

function buildTable(columns, data) {
    const table = $('#validation-table');
    const thead = table.find('thead tr');
    const tbody = table.find('tbody');
    
    // Clear existing content
    thead.find('th:not(:first)').remove();
    tbody.empty();
    
    // Build header row
    columns.forEach(function(col) {
        if (col !== 'key') {  // Skip 'key' column
            thead.append(`<th>${col}</th>`);
        }
    });
    
    // Build data rows
    data.forEach(function(rowData, index) {
        const rowIdx = rowData.row_idx;
        const isRowRejected = validationState.failed_rows.includes(rowIdx);
        const rowClass = isRowRejected ? 'row-rejected' : '';
        
        let rowHtml = `<tr class="${rowClass}" data-row-idx="${rowIdx}">`;
        rowHtml += `<td class="row-header" onclick="toggleRowRejection(${rowIdx})">${rowIdx + 1}</td>`;
        
        columns.forEach(function(col) {
            if (col !== 'key') {  // Skip 'key' column
                const cellValue = rowData.data[col] || '';
                const isCellRejected = validationState.failed_cells[rowIdx] && 
                                     validationState.failed_cells[rowIdx][col];
                const cellClass = isCellRejected ? 'rejected' : '';
                
                rowHtml += `<td class="data-cell ${cellClass}" 
                           onclick="toggleCellRejection(${rowIdx}, '${col}')"
                           title="${cellValue}">
                           ${cellValue}
                           </td>`;
            }
        });
        
        rowHtml += '</tr>';
        tbody.append(rowHtml);
    });
}

function toggleCellRejection(rowIdx, column) {
    const cell = $(`.data-cell[onclick*="${rowIdx}"][onclick*="${column}"]`);
    const isRejected = cell.hasClass('rejected');
    
    // Update server state
    $.ajax({
        url: '/reject_cell',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            row_idx: rowIdx,
            column: column,
            rejected: !isRejected
        }),
        success: function(response) {
            // Update UI
            cell.toggleClass('rejected');
            
            // Update local state
            if (!validationState.failed_cells[rowIdx]) {
                validationState.failed_cells[rowIdx] = {};
            }
            
            if (!isRejected) {
                validationState.failed_cells[rowIdx][column] = true;
            } else {
                delete validationState.failed_cells[rowIdx][column];
                if (Object.keys(validationState.failed_cells[rowIdx]).length === 0) {
                    delete validationState.failed_cells[rowIdx];
                }
            }
            
            updateValidationStats();
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to update cell';
            showError(error);
        }
    });
}

function toggleRowRejection(rowIdx) {
    const row = $(`tr[data-row-idx="${rowIdx}"]`);
    const isRejected = row.hasClass('row-rejected');
    
    // Update server state
    $.ajax({
        url: '/reject_row',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            row_idx: rowIdx,
            rejected: !isRejected
        }),
        success: function(response) {
            // Update UI
            row.toggleClass('row-rejected');
            
            // Update local state
            if (!isRejected) {
                validationState.failed_rows.push(rowIdx);
            } else {
                const index = validationState.failed_rows.indexOf(rowIdx);
                if (index > -1) {
                    validationState.failed_rows.splice(index, 1);
                }
            }
            
            updateValidationStats();
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to update row';
            showError(error);
        }
    });
}

function updateValidationStats() {
    $.get('/get_validation_stats')
        .done(function(stats) {
            $('#total-rows').text(stats.total_rows);
            $('#failed-rows').text(stats.failed_rows);
            
            const passRate = stats.total_rows > 0 ? 
                ((stats.total_rows - stats.failed_rows) / stats.total_rows * 100).toFixed(1) : 100;
            $('#pass-rate').text(passRate + '%');
            
            // Update field failures
            const fieldFailureList = $('#field-failure-list');
            fieldFailureList.empty();
            
            Object.entries(stats.field_failures).forEach(function([field, count]) {
                if (count > 0) {
                    fieldFailureList.append(`
                        <div class="stat-item">
                            <span>${field}:</span>
                            <span class="stat-value">${count}</span>
                        </div>
                    `);
                }
            });
            
            if (fieldFailureList.is(':empty')) {
                fieldFailureList.append('<div class="stat-item">No field failures</div>');
            }
        })
        .fail(function(xhr) {
            console.error('Failed to update stats:', xhr);
        });
}

function exportValidation() {
    window.location.href = '/export_validation';
}
</script>
{% endblock %}