{% extends "base.html" %}

{% block title %}Product Inspector - Simple Validation UI{% endblock %}

{% block extra_css %}
<style>
    .inspection-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .navigation-panel {
        background: white;
        border-radius: 4px;
        padding: 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 2rem;
    }

    .left-section {
        justify-self: start;
    }

    .center-section {
        justify-self: center;
    }

    .right-section {
        justify-self: end;
    }

    .nav-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .nav-controls button {
        min-width: 100px;
    }

    .nav-controls button:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
    }

    .current-position {
        font-weight: bold;
        color: #2c3e50;
        font-size: 1.1rem;
    }

    .llm-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        min-width: 300px;
    }

    .model-selection {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .model-selection label {
        font-weight: bold;
        color: #2c3e50;
    }

    .model-selection select {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        min-width: 150px;
    }

    .invoke-section {
        display: flex;
        align-items: center;
    }

    #invoke-llm-btn {
        background-color: #27ae60;
        padding: 0.5rem 1rem;
        min-width: 120px;
    }

    #invoke-llm-btn:hover:not(:disabled) {
        background-color: #219a52;
    }

    #invoke-llm-btn:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
    }

    #invoke-spinner {
        margin-left: 0.5rem;
    }

    .content-panels {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 400px auto;
        gap: 1rem;
    }

    .panel {
        background: white;
        border-radius: 4px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .raw-html-panel {
        grid-column: 1 / 2;
        grid-row: 1 / 2;
    }

    .prompt-panel {
        grid-column: 2 / 2;
        grid-row: 1 / 2;
    }

    .result-panel {
        grid-column: 1 / 3;
        grid-row: 2 / 3;
    }

    .panel h4 {
        margin-bottom: 1rem;
        color: #2c3e50;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .panel textarea {
        flex: 1;
        height: 100%;
        min-height: 300px;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0.5rem;
        resize: none;
    }

    .result-table {
        width: 100%;
        border-collapse: collapse;
    }

    .result-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #eee;
        vertical-align: top;
    }

    .result-table td:first-child {
        font-weight: bold;
        background-color: #f8f9fa;
        width: 120px;
        color: #2c3e50;
    }

    .result-table td:last-child {
        word-break: break-word;
    }

    .result-table tr:hover {
        background-color: #f8f9fa;
    }

    .results-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .no-results {
        padding: 2rem;
        text-align: center;
        color: #666;
        font-style: italic;
    }

    .result-entry {
        border-bottom: 1px solid #eee;
        margin-bottom: 0;
    }

    .result-entry:last-child {
        border-bottom: none;
    }

    .result-entry.original-result {
        border: 2px solid #3498db;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }

    .result-entry.original-result .result-header {
        background: #f0f8ff;
        border-left: 4px solid #3498db;
    }

    .result-header {
        background: #f8f9fa;
        padding: 0.75rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
    }

    .result-header:hover {
        background: #e9ecef;
    }

    .result-header.error {
        background: #fff5f5;
        border-left: 4px solid #e74c3c;
    }

    .result-header.success {
        background: #f0f8f0;
        border-left: 4px solid #27ae60;
    }

    .result-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .result-timestamp {
        font-size: 0.9rem;
        color: #666;
    }

    .result-model {
        background: #3498db;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .result-status {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .result-status.success {
        background: #d4edda;
        color: #155724;
    }

    .result-status.error {
        background: #f8d7da;
        color: #721c24;
    }

    .expand-icon {
        transition: transform 0.2s;
    }

    .expand-icon.expanded {
        transform: rotate(180deg);
    }

    .result-content {
        display: none;
        padding: 0;
    }

    .result-content.expanded {
        display: block;
    }

    .result-table-wrapper {
        padding: 1rem;
    }

    .result-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }

    .success-indicator {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .success-indicator.success {
        background-color: #d4edda;
        color: #155724;
    }

    .success-indicator.failed {
        background-color: #f8d7da;
        color: #721c24;
    }

    .copy-btn {
        background-color: #6c757d;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    .copy-btn:hover {
        background-color: #5a6268;
    }

    .goto-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .goto-controls input {
        width: 80px;
        padding: 0.25rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
    }

    .keyboard-shortcuts {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.5rem;
    }

    @media (max-width: 1200px) {
        .navigation-panel {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto;
            gap: 1rem;
        }
        
        .left-section, .center-section, .right-section {
            justify-self: center;
        }
        
        .content-panels {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto;
        }
        
        .raw-html-panel {
            grid-column: 1;
            grid-row: 1;
        }
        
        .prompt-panel {
            grid-column: 1;
            grid-row: 2;
        }
        
        .result-panel {
            grid-column: 1;
            grid-row: 3;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="loading">
    <h2>Loading product inspector...</h2>
</div>

<div class="content" style="display: none;">
    <div class="inspection-container">
        <div class="navigation-panel">
            <div class="left-section">
                <h3>Product Inspector</h3>
                <div class="keyboard-shortcuts">
                    Use ← → arrow keys to navigate | Enter to go to specific product
                </div>
            </div>
            
            <div class="center-section">
                <div class="nav-controls">
                    <button id="prev-btn" onclick="navigateProduct(-1)">← Previous</button>
                    <span class="current-position" id="current-position">- / -</span>
                    <button id="next-btn" onclick="navigateProduct(1)">Next →</button>
                    
                    <div class="goto-controls">
                        <span>Go to:</span>
                        <input type="number" id="goto-input" min="1" placeholder="1">
                        <button onclick="gotoProduct()">Go</button>
                    </div>
                </div>
            </div>
            
            <div class="right-section">
                <div class="llm-controls">
                    <div class="model-selection">
                        <label for="model-select">Model:</label>
                        <select id="model-select">
                            <option value="">Loading models...</option>
                        </select>
                    </div>
                    <div class="invoke-section">
                        <button id="invoke-llm-btn" onclick="invokeLLM()" disabled>
                            <span id="invoke-btn-text">Invoke LLM</span>
                            <span id="invoke-spinner" style="display: none;">⏳</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="content-panels">
            <div class="panel raw-html-panel">
                <h4>
                    Raw HTML Content
                    <button class="copy-btn" onclick="copyToClipboard('raw-html')">Copy</button>
                </h4>
                <textarea id="raw-html" readonly placeholder="Raw HTML content will appear here..."></textarea>
            </div>
            
            <div class="panel prompt-panel">
                <h4>
                    LLM Prompt
                    <button class="copy-btn" onclick="copyToClipboard('llm-prompt')">Copy</button>
                </h4>
                <textarea id="llm-prompt" readonly placeholder="LLM prompt will appear here..."></textarea>
            </div>
            
            <div class="panel result-panel">
                <h4>LLM Extraction Results</h4>
                <div class="results-container" id="results-container">
                    <div class="no-results" id="no-results">
                        No LLM results yet. Use "Invoke LLM" to generate new results.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentIndex = 0;
let totalProducts = 0;

function onDataLoaded(response) {
    totalProducts = response.total_products;
    $('#goto-input').attr('max', totalProducts);
    loadModels();
    loadProduct(0);
}

function loadProduct(index) {
    if (index < 0 || index >= totalProducts) {
        return;
    }
    
    currentIndex = index;
    
    // Update navigation state
    updateNavigationState();
    
    // Load product data
    $.get(`/get_product/${index}`)
        .done(function(data) {
            displayProduct(data);
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to load product';
            showError(error);
        });
}

function displayProduct(data) {
    // Update navigation info
    $('#current-position').text(`${data.index + 1} / ${data.total}`);
    
    // Update content areas
    $('#raw-html').val(data.raw_html);
    $('#llm-prompt').val(data.prompt);
    
    // Combine original LLM result with history
    const allResults = [];
    
    // Add original result as first entry if it exists
    if (data.llm_result && Object.keys(data.llm_result).length > 0) {
        const originalResult = {
            timestamp: 'Original Extraction',
            model: 'Initial Processing',
            success: true,
            result: data.llm_result,
            raw_response: '',
            error: null,
            isOriginal: true
        };
        allResults.push(originalResult);
    }
    
    // Add history results
    if (data.llm_history && data.llm_history.length > 0) {
        allResults.push(...data.llm_history);
    }
    
    // Display all results
    displayLLMResults(allResults);
    
    // Update goto input
    $('#goto-input').val(currentIndex + 1);
}

function updateNavigationState() {
    $('#prev-btn').prop('disabled', currentIndex <= 0);
    $('#next-btn').prop('disabled', currentIndex >= totalProducts - 1);
}

function navigateProduct(direction) {
    const newIndex = currentIndex + direction;
    if (newIndex >= 0 && newIndex < totalProducts) {
        loadProduct(newIndex);
    }
}

function gotoProduct() {
    const input = $('#goto-input').val();
    const targetIndex = parseInt(input) - 1; // Convert to 0-based index
    
    if (isNaN(targetIndex) || targetIndex < 0 || targetIndex >= totalProducts) {
        showError(`Invalid product number. Please enter a number between 1 and ${totalProducts}.`);
        return;
    }
    
    loadProduct(targetIndex);
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    button.style.backgroundColor = '#27ae60';
    
    setTimeout(function() {
        button.textContent = originalText;
        button.style.backgroundColor = '';
    }, 1000);
}

function loadModels() {
    $.get('/get_models')
        .done(function(response) {
            if (response.success) {
                const select = $('#model-select');
                select.empty();
                
                if (response.llm_available) {
                    select.append('<option value="">Select a model...</option>');
                    response.models.forEach(function(model) {
                        select.append(`<option value="${model}">${model}</option>`);
                    });
                    
                    // Enable the invoke button when model is selected
                    select.on('change', function() {
                        const invokeBtn = $('#invoke-llm-btn');
                        if ($(this).val()) {
                            invokeBtn.prop('disabled', false);
                        } else {
                            invokeBtn.prop('disabled', true);
                        }
                    });
                } else {
                    select.append('<option value="">LLM not available</option>');
                    $('#invoke-llm-btn').prop('disabled', true);
                }
            } else {
                $('#model-select').html('<option value="">Error loading models</option>');
                $('#invoke-llm-btn').prop('disabled', true);
            }
        })
        .fail(function(xhr) {
            $('#model-select').html('<option value="">Failed to load models</option>');
            $('#invoke-llm-btn').prop('disabled', true);
            console.error('Failed to load models:', xhr);
        });
}

function invokeLLM() {
    const model = $('#model-select').val();
    const prompt = $('#llm-prompt').val();
    
    if (!model) {
        showError('Please select a model first');
        return;
    }
    
    if (!prompt.trim()) {
        showError('Prompt is empty');
        return;
    }
    
    // Update UI for loading state
    const invokeBtn = $('#invoke-llm-btn');
    const btnText = $('#invoke-btn-text');
    const spinner = $('#invoke-spinner');
    
    invokeBtn.prop('disabled', true);
    btnText.text('Invoking...');
    spinner.show();
    
    // Clear any existing errors
    $('.error').fadeOut();
    
    $.ajax({
        url: '/invoke_llm',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            model: model,
            prompt: prompt,
            product_index: currentIndex
        }),
        success: function(response) {
            if (response.success) {
                // Update results display
                displayLLMResults(response.history);
                showSuccess('LLM invocation successful!');
            } else {
                showError('LLM invocation failed: ' + (response.error || 'Unknown error'));
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to invoke LLM';
            showError(error);
        },
        complete: function() {
            // Reset UI
            invokeBtn.prop('disabled', false);
            btnText.text('Invoke LLM');
            spinner.hide();
        }
    });
}

function displayLLMResults(results) {
    const container = $('#results-container');
    const noResults = $('#no-results');
    
    if (!results || results.length === 0) {
        noResults.show();
        container.find('.result-entry').remove();
        return;
    }
    
    noResults.hide();
    container.find('.result-entry').remove();
    
    results.forEach(function(result, index) {
        const resultHtml = createResultEntry(result, index);
        container.append(resultHtml);
    });
    
    // Expand the first (latest) result by default
    if (results.length > 0) {
        const firstEntry = container.find('.result-entry:first');
        toggleResultExpansion(firstEntry.find('.result-header')[0]);
    }
}

function createResultEntry(result, index) {
    const statusClass = result.success ? 'success' : 'error';
    const headerClass = result.success ? 'success' : 'error';
    const isOriginal = result.isOriginal || false;
    
    let resultTableHtml = '';
    if (result.success && result.result) {
        const data = result.result;
        resultTableHtml = `
            <div class="result-table-wrapper">
                <table class="result-table">
                    <tr><td>Image URL:</td><td>${makeClickable(data.image_url) || '-'}</td></tr>
                    <tr><td>Type:</td><td>${data.type || '-'}</td></tr>
                    <tr><td>Description:</td><td>${data.description || '-'}</td></tr>
                    <tr><td>Model No:</td><td>${data.model_no || '-'}</td></tr>
                    <tr><td>Product Link:</td><td>${makeClickable(data.product_link) || '-'}</td></tr>
                </table>
            </div>
        `;
    } else {
        resultTableHtml = `
            <div class="result-table-wrapper">
                <div style="color: #e74c3c; padding: 1rem;">
                    <strong>Error:</strong> ${result.error || 'Unknown error'}
                    <br><br>
                    <strong>Raw Response:</strong><br>
                    <pre style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; max-height: 200px; overflow-y: auto;">${result.raw_response || 'No response'}</pre>
                </div>
            </div>
        `;
    }
    
    const originalClass = isOriginal ? ' original-result' : '';
    const modelBadgeStyle = isOriginal ? 'background: #2c3e50;' : '';
    
    return `
        <div class="result-entry${originalClass}">
            <div class="result-header ${headerClass}" onclick="toggleResultExpansion(this)">
                <div class="result-info">
                    <span class="result-timestamp">${result.timestamp}</span>
                    <span class="result-model" style="${modelBadgeStyle}">${result.model}</span>
                    <span class="result-status ${statusClass}">${result.success ? 'SUCCESS' : 'ERROR'}</span>
                </div>
                <span class="expand-icon">▼</span>
            </div>
            <div class="result-content">
                ${resultTableHtml}
            </div>
        </div>
    `;
}

function toggleResultExpansion(header) {
    const entry = $(header).closest('.result-entry');
    const content = entry.find('.result-content');
    const icon = entry.find('.expand-icon');
    
    if (content.hasClass('expanded')) {
        content.removeClass('expanded');
        icon.removeClass('expanded');
    } else {
        content.addClass('expanded');
        icon.addClass('expanded');
    }
}

function makeClickable(url) {
    if (url && url.trim() && url.startsWith('http')) {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    }
    return url;
}

// Keyboard navigation
$(document).keydown(function(e) {
    // Only handle keys when not in an input field
    if (e.target.tagName.toLowerCase() === 'input' || e.target.tagName.toLowerCase() === 'textarea') {
        if (e.key === 'Enter' && e.target.id === 'goto-input') {
            gotoProduct();
        }
        return;
    }
    
    switch(e.key) {
        case 'ArrowLeft':
            e.preventDefault();
            navigateProduct(-1);
            break;
        case 'ArrowRight':
            e.preventDefault();
            navigateProduct(1);
            break;
        case 'Home':
            e.preventDefault();
            loadProduct(0);
            break;
        case 'End':
            e.preventDefault();
            loadProduct(totalProducts - 1);
            break;
    }
});
</script>
{% endblock %}